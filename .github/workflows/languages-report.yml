name: Languages report + graph

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1' # Mondays 06:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate language totals (JSON + Markdown)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const owner = context.repo.owner;

            const repos = await github.paginate(github.rest.repos.listForUser, {
              username: owner,
              per_page: 100,
              sort: "updated",
              direction: "desc",
            });

            const filtered = repos.filter(r => !r.fork);

            const sumValues = (obj) => Object.values(obj).reduce((a,b)=>a+b, 0);
            const toPct = (part, total) => total === 0 ? 0 : (part / total) * 100;

            const overall = {}; // language -> bytes
            const perRepo = [];

            for (const r of filtered) {
              const { data: langs } = await github.rest.repos.listLanguages({
                owner,
                repo: r.name,
              });

              const totalBytes = sumValues(langs);
              perRepo.push({ name: r.name, totalBytes, langs });

              for (const [lang, bytes] of Object.entries(langs)) {
                overall[lang] = (overall[lang] || 0) + bytes;
              }
            }

            // Write JSON for graph
            fs.mkdirSync("assets", { recursive: true });
            fs.writeFileSync("assets/l
