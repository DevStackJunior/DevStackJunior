name: Languages report + graph

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1' # Mondays 06:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure assets folder exists
        run: |
          mkdir -p assets
          ls -la
          ls -la assets || true

      - name: Debug generated files
        run: |
          echo "Tree:"
          find . -maxdepth 3 -type f | sort

      - name: Generate language totals (JSON + Markdown)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const owner = context.repo.owner;

            const repos = await github.paginate(github.rest.repos.listForUser, {
              username: owner,
              per_page: 100,
              sort: 'updated',
              direction: 'desc'
            });

            const filtered = repos.filter(r => !r.fork);

            function sumValues(obj) {
              return Object.values(obj).reduce((a, b) => a + b, 0);
            }

            function pct(part, total) {
              return total === 0 ? 0 : (part / total) * 100;
            }

            const overall = {};
            const perRepo = [];

            for (const r of filtered) {
              const resp = await github.rest.repos.listLanguages({ owner, repo: r.name });
              const langs = resp.data;

              const totalBytes = sumValues(langs);
              perRepo.push({ name: r.name, totalBytes, langs });

              for (const [lang, bytes] of Object.entries(langs)) {
                overall[lang] = (overall[lang] || 0) + bytes;
              }
            }

            fs.mkdirSync('assets', { recursive: true });
            fs.writeFileSync('assets/languages.json', JSON.stringify(overall, null, 2), 'utf8');

            const overallTotal = sumValues(overall);
            const overallSorted = Object.entries(overall).sort((a, b) => b[1] - a[1]);

            let full = '';
            full += '# Language usage report\n\n';
            full += 'Generated: ' + new Date().toISOString() + '\n\n';
            full += '## Overall (all repos combined)\n\n';
            full += '| Language | Share | Bytes |\n|---|---:|---:|\n';

            for (const [lang, bytes] of overallSorted) {
              full += '| ' + lang + ' | ' + pct(bytes, overallTotal).toFixed(2) + '% | ' + bytes.toLocaleString() + ' |\n';
            }

            full += '\nTotal bytes: **' + overallTotal.toLocaleString() + '**\n\n';

            perRepo.sort((a, b) => b.totalBytes - a.totalBytes);

            full += '## Per repository (top 5 languages)\n\n';
            full += '| Repo | Total bytes | Top languages |\n|---|---:|---|\n';

            for (const r of perRepo) {
              const entries = Object.entries(r.langs).sort((a, b) => b[1] - a[1]);
              const top5 = entries.slice(0, 5).map(([lang, bytes]) => {
                return lang + ' ' + pct(bytes, r.totalBytes).toFixed(1) + '%';
              }).join(', ');

              full += '| ' + r.name + ' | ' + r.totalBytes.toLocaleString() + ' | ' + (top5 || 'â€”') + ' |\n';
            }

            fs.writeFileSync('LANGUAGES.md', full, 'utf8');

            // README injection (between markers)
            const readmePath = 'README.md';
            if (fs.existsSync(readmePath)) {
              const readme = fs.readFileSync(readmePath, 'utf8');
              const start = '<!-- LANGUAGES:START -->';
              const end = '<!-- LANGUAGES:END -->';

              if (readme.includes(start) && readme.includes(end)) {
                let snippet = '';
                snippet += start + '\n\n';
                snippet += '### Overall (top 10)\n\n';
                snippet += '| Language | Share |\n|---|---:|\n';

                for (const [lang, bytes] of overallSorted.slice(0, 10)) {
                  snippet += '| ' + lang + ' | ' + pct(bytes, overallTotal).toFixed(2) + '% |\n';
                }

                snippet += '\nFull details in **LANGUAGES.md**.\n\n';
                snippet += end;

                const re = new RegExp(start + '[\\s\\S]*?' + end, 'm');
                const updated = readme.replace(re, snippet);
                fs.writeFileSync(readmePath, updated, 'utf8');
              }
            }
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install matplotlib
        run: |
          python -m pip install --upgrade pip
          python -m pip install matplotlib

      - name: Generate graph image
        run: |
          ls -la assets
          python scripts/languages_graph.py
          ls -la assets
      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md LANGUAGES.md assets scripts || true

          git status
          git diff --cached --quiet && exit 0
          git commit -m "chore: update languages report and graph"
          git push
